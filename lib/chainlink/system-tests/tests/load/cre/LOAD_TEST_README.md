



### 1. Compile the mock capability
1. Clone https://github.com/smartcontractkit/capabilities
2. Run `nx build mock`

This will compile the capability, it will be available in `bin/amd64/mock`

Note that the mock capability is not merged yet, use this branch https://github.com/smartcontractkit/capabilities/tree/registry-proxy. If the capability has already been merged, delete this line from the README.

### 2. Copy the capability to the chainlink `/plugins` dir
Run `cp bin/amd64/mock <PATH_TO_CHAINLINK>/system-tests/tests/smoke/capabilities/amd64_mock`
In this step we are also renaming the capability to `amd64_mock`

### 3. Change the plugins `chainlink.Dockerfile`
Add the following line to the dockerfile:
```diff
+ # For testing in CRIB
+ RUN mkdir /home/capabilities
+ COPY ./plugins/amd64_mock /home/capabilities

 RUN if [ ${CHAINLINK_USER} != root ]; then \
   useradd --uid 14933 --create-home ${CHAINLINK_USER}; \
   fi

+ RUN chown ${CHAINLINK_USER}:${CHAINLINK_USER} /home/capabilities
+ RUN chown ${CHAINLINK_USER}:${CHAINLINK_USER} /home/capabilities/amd64_mock
+ RUN chmod +x /home/capabilities/amd64_mock

```
This changes will make sure that the capability is copyed to the container and will be accessible to the chainlink node

### 4. Push your changes and wait for your image to be generated
The CI job we are targeting is `Build Chainlink Image (plugins)`, once that is done we will check `` and look for something like
```dockerfile
pushing manifest for ***.dkr.ecr.***.amazonaws.com/chainlink:f2addca86d976ffe0e11f36e60d3b91afcc0b44f-plugins@sha256:e21cdbeb35c81707dbf267fff19b25b6ea8148a5b1e7679bd3ae450586e82e13
```
Based on that the image name will be `chainlink:f2addca86d976ffe0e11f36e60d3b91afcc0b44f-plugins`

Copy the image name generated by your test and replace it inside the `system-tests/tests/smoke/cre/environment-workflow-don-load-test-streams.toml`
You will see a lot of
```
image = "***.dkr.ecr.***.amazonaws.com/chainlink:39ecc82f8429d8e96d099312ccad3470f3f2fc78-plugins"
```
replace all of the instances with your image name

### 5. Change anything you want inside the `environment-workflow-don-load-test-streams.toml` file

#### Workflow load
```toml
[workflow_load]
streams = 1000
jobs = 2
```
These values indicate the number of workflows and the number of streams per workflow, node that this not indicate the load that will be generated but the workflow jobs that will be created, these two values indicate the maximul number of "load" that you can generate.
The actual load is condigured when createing `NewStreamsGun`

### 6. Clone CRIB repo
Clone the CRIB repo and switch to the branch `dx-50-cre-crib-df-perf-testing`.
Update `environment-workflow-don-load-test-streams.toml`, we are looking for `infra.crib.folder_location`, point that to the crib directory on your machine.

Example:
```toml
[infra.crib]
namespace = "crib-workflow-don-load-test"
folder_location = "/Users/ionita/crib/deployments/cre"
provider = "aws"
```
Make sure you change the namespace as this is user based

### 7. Create your own .env inside `crib/deployments/cre`
You have an `.env.example` to start from

### 8. Spin up the CTF observability stack
Clone https://github.com/smartcontractkit/chainlink-testing-framework and run `ctf obs u` and copy `GRAFANA_TOKEN`,`GRAFANA_URL`,`LOKI_URL`.

### 9. Make sure you are on the VPN
Use the backup VPN for better stability

### 10. Run test
`CTF_CONFIGS=workflow-don-load-test-streams.toml DASHBOARD_FOLDER=LoadTests DASHBOARD_NAME=Wasp DATA_SOURCE_NAME=Loki GRAFANA_TOKEN=<YOUR_GRAFANA_TOKEN> GRAFANA_URL=http://localhost:3000 LOKI_URL=http://localhost:3030/loki/api/v1/push PRIVATE_KEY=ac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 CHAINLINK_CLUSTER_VERSION="2.6.0-preview-1896-f6cd441" LOAD_TEST="true" go test -run TestLoad_Workflow_Streams_MockCapabilities -timeout 60m`

Change the `GRAFANA_TOKEN` from what you got from `ctf obs u`

CHAINLINK_CLUSTER_VERSION="2.6.0-preview-1896-f6cd441" # contains the ingress mock
LOAD_TEST="true" # increases the resources of the capabilities and workflow nodes


## Chaos tests

! These tests require CRIB environment with 3 DONS: Asset, Workflow and Writer, and at least one EVM chain !

Chaos tests are added to the load test by default but can be run only on `main.stage`.

There are 3 modes:
- "clean" - no chaos tests
- "reorg" - EVM specific chaos suite - block reorganizations
- "rpc" - simulating realistic RPC latency
- "full" - running all the experiments

Turn your VPN on, add `[chaos.dashboard_uids]` on which the test will automatically add annotations, export 1Password `CRE chaos test vars` under `Eng Shared Vault` and run the test.

## Chaos tests without workload

If you want to apply the chaos test without workload or debug it you can use
```
go test -v -timeout 2h -run TestChaos
```

